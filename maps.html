<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maps</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            height: 450px;
            width: 650px;
        }

        button {
            background-color: #0051ffee;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <button onclick="saveMapAsImage()">Salvar Mapa</button>

    <script>
        const map = new ol.Map({
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM(),
                })
            ],
            target: 'map',
            view: new ol.View({
                center: ol.proj.fromLonLat([-49.0906601, -26.5046581]),
                zoom: 18, // Defina o nível de zoom padrão aqui
            })
        });

        var markerLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
        });

        map.addLayer(markerLayer);

        var marker;

        function addMarker(e) {
            var clickedCoordinate = e.coordinate;

            // Remover o marcador existente
            if (marker) {
                markerLayer.getSource().removeFeature(marker);
            }

            marker = new ol.Feature({
                geometry: new ol.geom.Point(clickedCoordinate),
            });

            // var markerStyle = new ol.style.Style({
            //     // Use a circle symbol for a simpler marker
            //     image: new ol.style.Circle({
            //         radius: 7, // Adjust radius for desired size
            //         fill: new ol.style.Fill({
            //             color: 'red' // Change color as needed
            //         })
            //     })
            // });

            var markerStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    src: 'google-309739_1280.webp', // URL to image file
                    width: 20
                    // or use Data URI
                    // src: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C9B0...'
                })
            });

            marker.setStyle(markerStyle);

            markerLayer.getSource().addFeature(marker);
        }

        map.on('click', addMarker);

        async function saveMapAsImage() {
            var mapContainer = document.getElementById('map');
            console.log('Iniciou a captura da div para imagem');
            await html2canvas(mapContainer, {
                useCORS: true,
                allowTaint: true,
            }).then(canvas => {
                console.log(canvas)
                document.body.appendChild(canvas);
                var imageData = canvas.toDataURL("image/png");

                var link = document.createElement('a');
                link.href = imageData;
                link.download = "mapa.png";
                link.click();
            });
        }
    </script>
</body>

</html>